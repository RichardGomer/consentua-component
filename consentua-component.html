<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<script src="../cryptojslib/rollups/md5.js"></script>
<script src="../cryptojslib/components/enc-base64-min.js"></script>
<link rel="import" href="consentua-icons.html">
<link rel="import" href="consentua-template.html">

<!--
`consentua-component` a web component to access and use <a href="consentua.com" >consentua</a>
 ### Styling
 Custom property | Description | Default
 ----------------|-------------|----------
 `--main-background-color` | The main background colour | `#e1e1e1`

@demo demo/index.html
-->

<dom-module id="consentua-component">
  <template>
    <style>
      :host {
        --consentua-main:#9A1144;
        --main-background-color: #e1e1e1;
        --green-l:#4CAF50;
        --green-d:#265728;
        --primary-color:var(--green-l);
        width: 100%;
        height: 100%;
        display: block;
        background-color: var(--main-background-color);
        padding: 1em 0em;
      }
      paper-button{
        background-color: var(--green-l);
        color: #fff;
        text-transform: capitalize;
        min-width: 22%;
      }
      paper-button[disabled]{
        background-color: var(--green-d);
      }
      #pageControls{
        margin-top: 2em;
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      #branding{
        margin-top: 1em;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        font-size: 0.9em;
      }
      #branding img{
        background-color: var(--consentua-main);
        padding: 7px;
        max-height: 20px;
        margin: 0px 5px;
      }
      .no-data{
        background-color: var(--consentua-main);
        text-align: center;
        color: #fff;
        padding: 2em;
        max-width: 40%;
        margin: 0px auto;
      }
    </style>
      <!-- demo template -->
      <iron-ajax
         auto
         url="template.json"
         handle-as="json"
         last-response="{{data}}"></iron-ajax>
     <iron-ajax
         auto
         url="[[apiEndpoint]]/login/Service"
         body="[[loginBody]]"
         method="POST"
         content-type="application/json"
         handle-as="json"
         on-response="_resLogin"></iron-ajax>
<!--      <iron-ajax
         id="getTemplateAjax"
         url="[[apiEndpoint]]/template/Get"
         params='[[_getTemplateParams()]]'
         handle-as="json"
         last-response="{{data}}"></iron-ajax> -->


      <!-- there is data -->
      <template is="dom-if" if="{{isData}}">
      <!-- each template is a page -->
       <iron-pages selected="{{selectedMainPage}}" id="pageMain">
          <template is="dom-repeat" items="[[data.Templates]]">
            <consentua-template template="[[item]]"></consentua-template>
          </template>
       </iron-pages>

      <div id="pageControls">
        <paper-button id="btnPrev" raised on-tap="_prevPage">Previous</paper-button>
        <span>[[_mainAdder(selectedMainPage)]]/[[_totMainPages(data)]]</span>
        <paper-button id="btnNext" raised on-tap="_nextPage">Next</paper-button>
      </div>
      <span id="branding">
        Service provided by
        <img src="../img/consentua-logo-white.svg">
      </span>
      </template>

    <!-- there is no data -->
    <template is="dom-if" if="{{!isData}}">
      <section class="no-data">
        <iron-icon icon="consentua-icons:mood-bad"></iron-icon>
        <p>No consent tempaltes found</p>
        <img src="../img/consentua-logo-white.svg">
      </section>
    </template>

  </template>
  <script>
    /**
     * `consentua-component`
     * consentua component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ConsentuaComponent extends Polymer.Element {
      static get is() { return 'consentua-component'; }
      static get properties() {
        return {
          key:{
            type: String,
            readOnly: true,
            notify: true
          },
          formatedToken: {
            type: String,
            notify: true,
            computed: '_formatToken(key)'
          },
          accessToken:{
            type: String,
            notify: true
          },
          clientId:{
            type: String,
            readOnly: true,
            notify: true
          },
          serviceId:{
            type: String,
            readOnly: true,
            notify: true
          },
          deviceId:{
            type: String,
            readOnly: true,
            notify: true
          },
          language: {
            type: String,
            notify: true,
            value: 'en'
          },
          apiEndpoint:{
            type: String,
            notify: true,
            value: 'http://api.consentua.com'
          },
          loginBody: {
            type: Object,
            notify: true,
            computed: '_returnLoginBody(formatedToken, clientId, serviceId, deviceId)'
          },
          data: {
            type: Object,
            notify: true,
            value: {}
          },
          isData: {
            type: Boolean,
            notify: true,
            computed: '_isData(data)'
          },
          selectedMainPage:{
            type: Number,
            notify: true,
            value: 0
          },
        };
      }
      ready() {
        super.ready();
        this.addEventListener('iron-ajax-error', e => this._resErr(e));
      }
      _formatToken(key){
       //get date and it to the key, then hash
       var date = new Date().getDate();
       var month = new Date().getMonth() +1; //add 1 to month, as it starts from 0, not 1
       var year = new Date().getFullYear();
       var fullDate = "_" + date + "_" + month + "_" + year;
       var hash = CryptoJS.MD5(key + fullDate).toString();
       return hash;
      }
      _returnLoginBody(formatedToken, clientId, serviceId, deviceId){
        return {
          ClientId: this.clientId,
          ServiceId: this.serviceId,
          LoginToken: this.formatedToken,
          DeviceId: this.deviceId //https://github.com/Valve/fingerprintjs2 
        };
      }
      _getTemplateParams(){
        return {
          "clientId": this.clientId,
          "serviceId": this.serviceId,
          "accessToken":  this.accessToken,
          "language":  this.language
        };
      }
      _pageBinary(page){
        if (page == 'binary' || page == 'Binary' || page == 'BINARY'){
         return true;
         } else{
          return false;
         }
      }
      _pageLinear(page){
        if (page == 'linear' || page == 'Linear' || page == 'LINEAR'){
         return true;
         } else{
          return false;
         }
      }
      _isData(data){
        if (data == null || data == undefined || Object.keys(data).length === 0 && data.constructor === Object) {
          return false;
        } else{
          return true;
        }
      }
      _totMainPages(data){
        console.log("this.data", this.data);
        return this.data.Templates.length + 1;
      }
      _mainAdder(n){
        return n + 1;
      } 
      _prevPage(e, selectedMainPage){
        if (this.selectedMainPage == 0) {
          // do nothing
        } else{
          this.selectedMainPage--;
        }
        // var disabled = this.$.btnPrev.disabled;
        // console.log("selectedMainPage", this.selectedMainPage);
        // console.log("selectedMainPage", this.selectedMainPage);
      }
      _nextPage(e, selectedMainPage){
        // var disabled = this.$.btnNext.disabled;
        var tot = this._totMainPages();
        if (this.selectedMainPage >= tot) {
          // do nothing
        } else{
          this.selectedMainPage++;
        }
      }
      _isDisabled(e, selectedMainPage){
        if (!e.disabled) {
          this.$.btnPrev.disabled = false;
          this.$.btnNext.disabled = false;
          e.disabled = true;
        } else{
          console.log("how did you click this?");
        }
      }
      _resErr(fault){
        if (typeof fault === 'object'){
          fault = fault.detail.error.message;
        }
        console.error("Error with AJAX: " + fault);
      }
      _resLogin(event){
        var res = event.detail.response;
        if (res.Success) {
          console.log("service logged in!");
          this.accessToken = event.detail.response.Token;
          console.log("this.accessToken", this.accessToken);
          this.$.getTemplateAjax.generateRequest();
        } else{
          this._resErr("Failure to login");
      }
      
      }
    }

    window.customElements.define(ConsentuaComponent.is, ConsentuaComponent);
  </script>
</dom-module>
